// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums mappés sur les ENUMs SQL (avec accents/espaces gérés via @map)
enum Role {
  ADMIN
  MANAGER
  MANAGER_MULTI
  CAISSIER
  CAISSE_RESTAURANT
  CAISSE_BAR
  ECONOMAT
  MAGASINIER
  LOCATION
  CAISSE_PHARMACIE
  PHARMACIE
  STOCK
  OTHER
  CONSEIL_ADMINISTRATION
  SUPERVISEUR
  CAISSE_LOCATION
}

enum Module {
  PHARMACIE  @map("pharmacie")
  RESTAURANT @map("restaurant")
}

enum ModePaiement {
  CASH  @map("cash")
  CARTE @map("carte")
  MOBILE @map("mobile")
}

enum Devise {
  FRANC
  DOLLAR
}

enum StatutCommande {
  EN_ATTENTE     @map("en attente")
  EN_PREPARATION @map("en préparation")
  SERVI          @map("servi")
  PAYE           @map("payé")
}

enum StatutCommandeBar {
  EN_COURS  @map("en_cours")
  VALIDEE   @map("validée")
  ANNULEE   @map("annulée")
}

enum TypeMouvementStock {
  ENTREE @map("entrée")
  SORTIE @map("sortie")
}

enum TypeBien {
  APPARTEMENT      @map("appartement")
  BUREAU           @map("bureau")
  LOCAL_COMMERCIAL @map("local_commercial")
  AUTRE            @map("autre")
}

enum NiveauBien {
  REZ_DE_CHAUSSEE @map("rez_de_chaussee")
  N1              @map("n1")
  N2              @map("n2")
  N3              @map("n3")
  N4              @map("n4")
}

enum EtatBien {
  LIBRE      @map("libre")
  OCCUPE     @map("occupé")
  MAINTENANCE @map("maintenance")
}

enum StatutContrat {
  ACTIF     @map("actif")
  TERMINE   @map("termine")
  EN_ATTENTE @map("en_attente")
}

enum RolePersonnel {
  SERVEUR @map("serveur")
  BARMAN  @map("barman")
}

enum TypeDocument {
  PHOTO   @map("photo")
  CONTRAT @map("contrat")
  AUTRE   @map("autre")
}

model utilisateur {
  id            Int      @id @default(autoincrement())
  nom           String
  email         String   @unique
  mot_de_passe  String
  role          Role
  date_creation DateTime @default(now())

  // Relations
  commandes          commande[]            @relation("CommandeUtilisateur")
  commandes_serveur  commande[]            @relation("CommandeServeur")
  commandes_caissier commande[]            @relation("CommandeCaissier")
  paiements_caissier paiement[]
  ventes_pharmacie   vente_pharmacie[]

  @@map("utilisateur")
}

model categorie_medicament {
  id   Int    @id @default(autoincrement())
  nom  String

  // Relations
  medicaments medicament[]

  @@map("categorie_medicament")
}

model medicament {
  id              Int       @id @default(autoincrement())
  nom             String
  categorie_id    Int?
  prix_unitaire   Decimal   @db.Decimal(10, 2)
  quantite_stock  Int       @default(0)
  date_expiration DateTime? @db.Date

  // Relations
  categorie categorie_medicament? @relation(fields: [categorie_id], references: [id], onDelete: SetNull)
  details_ventes details_vente_pharmacie[]

  @@index([categorie_id])
  @@map("medicament")
}

model vente_pharmacie {
  id            Int       @id @default(autoincrement())
  utilisateur_id Int?
  total         Decimal?  @db.Decimal(10, 2)
  date_vente    DateTime? @default(now())

  // Relations
  utilisateur utilisateur? @relation(fields: [utilisateur_id], references: [id])
  details     details_vente_pharmacie[]

  @@index([utilisateur_id])
  @@map("vente_pharmacie")
}

model details_vente_pharmacie {
  id           Int      @id @default(autoincrement())
  vente_id     Int?
  medicament_id Int?
  quantite     Int
  prix_total   Decimal @db.Decimal(10, 2)

  // Relations
  vente      vente_pharmacie? @relation(fields: [vente_id], references: [id], onDelete: Cascade)
  medicament medicament?      @relation(fields: [medicament_id], references: [id])

  @@index([vente_id])
  @@index([medicament_id])
  @@map("details_vente_pharmacie")
}

model categorie_repas {
  id  Int    @id @default(autoincrement())
  nom String

  // Relations
  repas repas[]

  @@map("categorie_repas")
}

model repas {
  id           Int     @id @default(autoincrement())
  nom          String
  categorie_id Int?
  prix         Decimal @db.Decimal(10, 2)
  disponible   Boolean @default(true)

  // Relations
  categorie categorie_repas? @relation(fields: [categorie_id], references: [id], onDelete: SetNull)
  details   details_commande[]

  @@index([categorie_id])
  @@map("repas")
}

model table_restaurant {
  id   Int    @id @default(autoincrement())
  numero String @unique
  capacite Int @default(1)
  statut String @default("libre")
  date_creation DateTime @default(now())

  @@map("table_restaurant")
}

model commande {
  id             Int             @id @default(autoincrement())
  utilisateur_id Int?
  serveur_id     Int?
  caissier_id    Int?
  table_numero   String?
  total          Decimal?        @db.Decimal(10, 2)
  total_dollars  Decimal?        @db.Decimal(10, 2)
  statut         StatutCommande  @default(EN_ATTENTE)
  date_commande  DateTime?       @default(now())

  // Relations
  utilisateur    utilisateur?     @relation("CommandeUtilisateur", fields: [utilisateur_id], references: [id])
  serveur        utilisateur?     @relation("CommandeServeur", fields: [serveur_id], references: [id])
  caissier       utilisateur?     @relation("CommandeCaissier", fields: [caissier_id], references: [id])
  details        details_commande[]
  boissons       commande_boissons_restaurant[]
  commandes_bar  commandes_bar[] @relation("CommandeRestaurantBar") // Commandes bar liées à cette commande restaurant

  @@index([utilisateur_id])
  @@index([serveur_id])
  @@index([caissier_id])
  @@map("commande")
}

model details_commande {
  id           Int      @id @default(autoincrement())
  commande_id  Int?
  repas_id     Int?
  quantite     Int
  prix_unitaire Decimal @db.Decimal(10, 2)
  prix_total   Decimal @db.Decimal(10, 2)

  // Relations
  commande commande? @relation(fields: [commande_id], references: [id], onDelete: Cascade)
  repas     repas?    @relation(fields: [repas_id], references: [id])

  @@index([commande_id])
  @@index([repas_id])
  @@map("details_commande")
}

model paiement {
  id            Int          @id @default(autoincrement())
  module        Module
  reference_id  Int
  montant       Decimal      @db.Decimal(10, 2)
  mode_paiement ModePaiement @default(CASH)
  devise        Devise       @default(FRANC)
  caissier_id   Int?
  date_paiement DateTime?    @default(now())

  // Relations
  caissier utilisateur? @relation(fields: [caissier_id], references: [id])

  @@index([caissier_id])
  @@map("paiement")
}

// MODULE 3: BAR / TERRASSE
model categories_boissons {
  id   Int    @id @default(autoincrement())
  nom  String

  boissons boissons[]

  @@map("categories_boissons")
}

model boissons {
  id            Int      @id @default(autoincrement())
  nom           String
  categorie_id Int?
  prix_achat    Decimal  @db.Decimal(10, 2)
  prix_vente    Decimal  @db.Decimal(10, 2)
  stock         Int      @default(0)
  unite_mesure  String   @default("unités")

  categorie categories_boissons? @relation(fields: [categorie_id], references: [id], onDelete: SetNull)
  commande_details commande_details[]
  commandes_restaurant commande_boissons_restaurant[] @relation("BoissonsRestaurant")
  mouvements_stock mouvements_stock[]

  @@index([categorie_id])
  @@map("boissons")
}

model personnel {
  id   Int           @id @default(autoincrement())
  nom  String
  role RolePersonnel

  commandes commandes_bar[]
  commissions commissions[]

  @@map("personnel")
}

model tables_service {
  id       Int    @id @default(autoincrement())
  nom      String
  capacite Int    @default(0)

  commandes commandes_bar[]

  @@map("tables_service")
}

model commandes_bar {
  id                    Int              @id @default(autoincrement())
  table_id              Int?
  serveur_id            Int?
  commande_restaurant_id Int?            // Lien vers la commande restaurant si créée par le caissier restaurant
  date_commande         DateTime?         @default(now())
  status                StatutCommandeBar @default(EN_COURS)

  table                 tables_service?   @relation(fields: [table_id], references: [id], onDelete: SetNull)
  serveur               personnel?        @relation(fields: [serveur_id], references: [id], onDelete: SetNull)
  commande_restaurant   commande?        @relation("CommandeRestaurantBar", fields: [commande_restaurant_id], references: [id], onDelete: SetNull)
  details                commande_details[]
  facture                factures?

  @@index([table_id])
  @@index([serveur_id])
  @@index([commande_restaurant_id])
  @@map("commandes")
}

model commande_details {
  id          Int      @id @default(autoincrement())
  commande_id Int?
  boisson_id  Int?
  quantite    Int      @default(1)
  prix_total  Decimal  @db.Decimal(10, 2)

  commande commandes_bar? @relation(fields: [commande_id], references: [id], onDelete: Cascade)
  boisson  boissons?     @relation(fields: [boisson_id], references: [id], onDelete: SetNull)

  @@index([commande_id])
  @@index([boisson_id])
  @@map("commande_details")
}

// Table de liaison pour les boissons dans les commandes restaurant
model commande_boissons_restaurant {
  id           Int      @id @default(autoincrement())
  commande_id  Int?
  boisson_id   Int?
  quantite     Int      @default(1)
  prix_unitaire Decimal @db.Decimal(10, 2)
  prix_total   Decimal  @db.Decimal(10, 2)

  commande commande? @relation(fields: [commande_id], references: [id], onDelete: Cascade)
  boisson  boissons? @relation("BoissonsRestaurant", fields: [boisson_id], references: [id], onDelete: SetNull)

  @@index([commande_id])
  @@index([boisson_id])
  @@map("commande_boissons_restaurant")
}

model mouvements_stock {
  id             Int              @id @default(autoincrement())
  boisson_id     Int?
  type           TypeMouvementStock
  quantite       Int
  date_mouvement DateTime?        @default(now())

  boisson boissons? @relation(fields: [boisson_id], references: [id], onDelete: SetNull)

  @@index([boisson_id])
  @@map("mouvements_stock")
}

model factures {
  id            Int       @id @default(autoincrement())
  commande_id   Int?      @unique
  total         Decimal   @db.Decimal(10, 2)
  taxes         Decimal   @default(0) @db.Decimal(10, 2)
  date_facture  DateTime? @default(now())

  commande commandes_bar? @relation(fields: [commande_id], references: [id], onDelete: SetNull)

  @@index([commande_id])
  @@map("factures")
}

model commissions {
  id          Int      @id @default(autoincrement())
  personnel_id Int?
  montant     Decimal  @db.Decimal(10, 2)
  periode     DateTime @db.Date

  personnel personnel? @relation(fields: [personnel_id], references: [id], onDelete: SetNull)

  @@index([personnel_id])
  @@map("commissions")
}

// MODULE 4: LOCATION
model biens {
  id           Int      @id @default(autoincrement())
  type         TypeBien
  nom          String?
  niveau       NiveauBien?
  adresse      String
  superficie   Decimal  @db.Decimal(10, 2)
  prix_mensuel Decimal  @db.Decimal(10, 2)
  description  String?  @db.Text
  etat         EtatBien @default(LIBRE)
  nombre_pieces Int?

  documents biens_documents[]
  contrats  contrats[]

  @@map("biens")
}

model biens_documents {
  id             Int          @id @default(autoincrement())
  bien_id        Int?
  type_document  TypeDocument @default(PHOTO)
  chemin_fichier String?

  bien biens? @relation(fields: [bien_id], references: [id], onDelete: Cascade)

  @@index([bien_id])
  @@map("biens_documents")
}

model locataires {
  id             Int    @id @default(autoincrement())
  nom            String
  contact        String?
  profession     String?
  piece_identite String?

  contrats contrats[]

  @@map("locataires")
}

model contrats {
  id             Int           @id @default(autoincrement())
  bien_id        Int?
  locataire_id   Int?
  date_debut     DateTime       @db.Date
  date_fin       DateTime       @db.Date
  depot_garantie Decimal?       @db.Decimal(10, 2)
  avance         Decimal?       @db.Decimal(10, 2)
  statut         StatutContrat  @default(EN_ATTENTE)

  bien      biens?      @relation(fields: [bien_id], references: [id], onDelete: SetNull)
  locataire locataires? @relation(fields: [locataire_id], references: [id], onDelete: SetNull)
  paiements paiements_location[]

  @@index([bien_id])
  @@index([locataire_id])
  @@map("contrats")
}

model paiements_location {
  id            Int      @id @default(autoincrement())
  contrat_id   Int?
  montant       Decimal  @db.Decimal(10, 2)
  date_paiement DateTime @default(now()) @db.Date
  reste_du      Decimal  @default(0) @db.Decimal(10, 2)
  penalite      Decimal  @default(0) @db.Decimal(10, 2)

  contrat contrats? @relation(fields: [contrat_id], references: [id], onDelete: SetNull)

  @@index([contrat_id])
  @@map("paiements")
}
